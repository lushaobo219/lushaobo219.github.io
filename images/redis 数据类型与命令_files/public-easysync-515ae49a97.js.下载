var Easysync=function(t){"use strict";var e=function(){function t(){this._numToAttrib={},this._attribToNum={},this._nextNum=0}return t.prototype.numToAttrib=function(t){return this._numToAttrib[t]},t.prototype.attribToNum=function(t){return this._attribToNum[String(t)]},t.prototype.putAttrib=function(t,e){var r=String(t),n=this._attribToNum[r];return void 0!==n&&n>=0?n:e?-1:(n=this._nextNum++,this._attribToNum[r]=n,this._numToAttrib[n]=[String(t[0]||""),String(t[1]||"")],n)},t.prototype.getAttrib=function(t){var e=this._numToAttrib[t];return void 0!==e?[e[0],e[1]]:null},t.prototype.getAttribKey=function(t){var e=this._numToAttrib[t];return void 0!==e?e[0]:""},t.prototype.getAttribValue=function(t){var e=this._numToAttrib[t];return void 0!==e?e[1]:""},t.prototype.eachAttrib=function(t){for(var e=0,r=Object.keys(this._numToAttrib);e<r.length;e++){var n=r[e],i=this._numToAttrib[Number(n)];if(t(i[0],i[1],parseInt(n,10)))break}},t.prototype.copy=function(){var e=new t;return this.eachAttrib((function(t,r){return e.putAttrib([t,r]),!1})),e},t.prototype.modifyAttribs=function(t){for(var e=0;e<this._nextNum;e++){var r=e,n=this._numToAttrib[r];if(void 0!==n){var i=String(n),s=[n[0],t(n[0],n[1])];this._numToAttrib[r]=s,delete this._attribToNum[i];var o=String(s);this._attribToNum[o]=r}}},t.prototype.clear=function(){this._numToAttrib={},this._attribToNum={},this._nextNum=0},t.prototype.toJsonable=function(){return{numToAttrib:this._numToAttrib,nextNum:this._nextNum}},t.fromJsonable=function(e){var r=new t;return r._numToAttrib=e.numToAttrib,r._nextNum=e.nextNum,Object.keys(e.numToAttrib).forEach((function(t){var n=e.numToAttrib[t];r._attribToNum[String(n)]=Number(t)})),r},t}(),r=function(){function t(){}return t.error=function(t){window.log&&window.log.error("changeset error: "+t);var e=new Error;if(e.name="CHANGESET_ERROR_EASYSYNC",e.message="reason: "+t,!this.autoReport)throw e;window.ReportHelper&&window.ReportHelper.captureChangesetException&&window.ReportHelper.captureChangesetException("CHANGESET_ERROR_EASYSYNC",{option:{}},e)},t.assert=function(e){for(var r=[],n=1;n<arguments.length;n++)r[n-1]=arguments[n];e||t.error("Changeset: "+r.join(""))},t.trim=function(t){return t.replace(/^\s\s*/,"").replace(/\s\s*$/,"")},t.autoReport=!0,t}(),n=function(){function t(t,e){this._regex=/((?:\*[0-9a-z]+)*)(?:\|([0-9a-z]+))?([-+=])([0-9a-z]+)|\?|/g,this._startIndex=e||0,this._curIndex=this._startIndex,this._prevIndex=this._curIndex,this._opsStr=t,this._regexResult=this.nextRegexMatch(),this._optObj=a.newOp()}return t.prototype.nextRegexMatch=function(){this._prevIndex=this._curIndex,this._regex.lastIndex=this._curIndex;var t=this._regex.exec(this._opsStr);return this._curIndex=this._regex.lastIndex,t&&"?"!==t[0]||r.error("Hit error opcode in op stream"),t},t.prototype.next=function(t){var e=t||this._optObj;return this._regexResult&&this._regexResult[0]?(e.attribs=this._regexResult[1],e.lines=0,e.opcode=this._regexResult[3],e.chars=a.parseNum(this._regexResult[4]),this._regexResult=this.nextRegexMatch()):a.clearOp(e),e},t.prototype.hasNext=function(){return!(!this._regexResult||!this._regexResult[0])},t.prototype.peekNext=function(){var t=this._optObj;return this._regexResult&&this._regexResult[0]?(t.attribs=this._regexResult[1],t.lines=0,t.opcode=this._regexResult[3],t.chars=a.parseNum(this._regexResult[4])):a.clearOp(t),t},t.prototype.lastIndex=function(){return this._prevIndex},t}(),i=function(){function t(t){this._curIndex=0,this._str=t}return t.prototype._assertRemaining=function(t){r.assert(t<=this.remaining(),"!(",String(t)," <= ",String(this.remaining()),")")},t.prototype.take=function(t){this._assertRemaining(t);var e=this._str.substr(this._curIndex,t);return this._curIndex+=t,e},t.prototype.peek=function(t){return this._assertRemaining(t),this._str.substr(this._curIndex,t)},t.prototype.skip=function(t){this._assertRemaining(t),this._curIndex+=t},t.prototype.remaining=function(){return this._str.length-this._curIndex},t}(),s=function(){function t(t){this._curSplice=[0,0],this._inSplice=!1,this._curLine=0,this._curCol=0,this._lines=t}return t.prototype._lines_applySplice=function(t){this._lines.splice.apply(this._lines,t)},t.prototype._lines_get=function(t){return this._lines instanceof Array?this._lines[t]:this._lines.get?this._lines.get(t):null},t.prototype._lines_slice=function(t,e){return this._lines instanceof Array||this._lines.slice?this._lines.slice(t,e):null},t.prototype._lines_length=function(){return this._lines instanceof Array?this._lines.length:this._lines.length?this._lines.length():0},t.prototype._enterSplice=function(){this._curSplice[0]=this._curLine,this._curSplice[1]=0,this._curCol>0&&this._putCurLineInSplice(),this._inSplice=!0},t.prototype._leaveSplice=function(){this._lines_applySplice(this._curSplice),this._curSplice.length=2,this._curSplice[0]=this._curSplice[1]=0,this._inSplice=!1},t.prototype._isCurLineInSplice=function(){return this._curLine-this._curSplice[0]<this._curSplice.length-2},t.prototype._putCurLineInSplice=function(){return this._isCurLineInSplice()||this._lines_length()>this._curSplice[0]+this._curSplice[1]&&(this._curSplice.push(this._lines_get(this._curSplice[0]+this._curSplice[1])),this._curSplice[1]++),2+this._curLine-this._curSplice[0]},t.prototype.skipLines=function(t,e){if(t)if(e){this._inSplice||this._enterSplice();for(var r=0;r<t;r++)this._curCol=0,this._putCurLineInSplice(),this._curLine++}else this._inSplice&&(t>1?this._leaveSplice():this._putCurLineInSplice()),this._curLine+=t,this._curCol=0},t.prototype.skip=function(t,e,r){t&&(e?this.skipLines(e,r):(r&&!this._inSplice&&this._enterSplice(),this._inSplice&&this._putCurLineInSplice(),this._curCol+=t))},t.prototype._nextKLinesText=function(t){var e=this._curSplice[0]+this._curSplice[1];return this._lines_slice(e,e+t).join("")},t.prototype.removeLines=function(t){var e="";if(t)if(this._inSplice||this._enterSplice(),this._isCurLineInSplice())if(0===this._curCol)e=this._curSplice[this._curSplice.length-1],this._curSplice.length--,e+=this._nextKLinesText(t-1),this._curSplice[1]+=t-1;else{e=this._nextKLinesText(t-1),this._curSplice[1]+=t-1;var r=this._curSplice.length-1;if(r>=2){var n=this._curSplice[r];e=n.substring(this._curCol)+e,this._curSplice[r]=n.substring(0,this._curCol)+this._lines_get(this._curSplice[0]+this._curSplice[1]),this._curSplice[1]+=1}}else e=this._nextKLinesText(t),this._curSplice[1]+=t;return e},t.prototype.remove=function(t,e){var r="";if(t){if(e)return this.removeLines(e);this._inSplice||this._enterSplice();var n=this._putCurLineInSplice();if(n>=2){var i=this._curSplice[n];r=i.substring(this._curCol,this._curCol+t),this._curSplice[n]=i.substring(0,this._curCol)+i.substring(this._curCol+t)}}return r},t.prototype.insert=function(t,e){if(t)if(this._inSplice||this._enterSplice(),e){var r=a.splitTextLines(t);if(r)if(this._isCurLineInSplice()){if((s=this._curSplice.length-1)>=2){var n=this._curSplice[s],i=this._curCol;this._curSplice[s]=n.substring(0,i)+r[0],this._curLine++,r.splice(0,1),Array.prototype.push.apply(this._curSplice,r),this._curLine+=r.length,n.substring(i)&&this._curSplice.push(n.substring(i)),this._curCol=0}}else Array.prototype.push.apply(this._curSplice,r),this._curLine+=r.length}else{var s;if((s=this._putCurLineInSplice())>=2){var o=(n=this._curSplice[s])?n.substring(0,this._curCol):"",p=n?n.substring(this._curCol):"";this._curSplice[s]=o+t+p,this._curCol+=t.length}}},t.prototype.hasMore=function(){var t=this._lines_length();return this._inSplice&&(t+=this._curSplice.length-2-this._curSplice[1]),this._curLine<t},t.prototype.close=function(){this._inSplice&&this._leaveSplice()},t}(),o=function(){function t(t){this._assem=a.smartOpAssembler(),this._op=a.newOp(),this._charBank=a.stringAssembler(),this._oldLen=t}return t.prototype.keep=function(t,e,r,n){return this._op.opcode="=",this._op.attribs=r&&a.makeAttribsString("=",r,n)||"",this._op.chars=t,this._op.lines=0,this._assem.append(this._op),this},t.prototype.keepText=function(t,e,r){return this._assem.appendOpWithText("=",t,e,r),this},t.prototype.insert=function(t,e,r){return this._assem.appendOpWithText("+",t,e,r),this._charBank.append(t),this},t.prototype.remove=function(t,e){return this._op.opcode="-",this._op.attribs="",this._op.chars=t,this._op.lines=0,this._assem.append(this._op),this},t.prototype.insertAText=function(t){return a.appendATextToAssembler(t,this._assem,!0),this._charBank.append(t.text),this},t.prototype.toAtext=function(){return this._assem.endDocument(),{attribs:this._assem.toString(),text:this._charBank.toString()}},t.prototype.toString=function(){if(void 0===this._oldLen)return"";this._assem.endDocument();var t=this._oldLen+this._assem.getLengthChange();return a.pack({oldLen:this._oldLen,newLen:t,opsStr:this._assem.toString(),charBank:this._charBank.toString()})},t}(),p=function(){function t(t,e,r,n){this._curLine=0,this._curChar=0,this._curLineOpIter=null,this._curLineOpIterLine=0,this._curLineNextOp=a.newOp("+"),this._csIter=null,this._builder=null,this._cs=t,this._lines=e,this._alines=r,this._pool=n,this._unpacked=a.unpack(this._cs),this._unpacked&&(this._csIter=a.opIterator(this._unpacked.opsStr),this._builder=a.builder(this._unpacked.newLen))}return t.prototype._lines_get=function(t){return this._lines instanceof Array?this._lines[t]:this._lines.get(t)},t.prototype._lines_length=function(){return this._lines instanceof Array?this._lines.length:this._lines.length()},t.prototype._alines_get=function(t){return this._alines instanceof Array?this._alines[t]:this._alines.get(t)},t.prototype._alines_length=function(){return this._alines instanceof Array?this._alines.length:this._alines.length()},t.prototype._consumeAttribRuns=function(t,e){if(!this._curLineOpIter||this._curLineOpIterLine!==this._curLine){this._curLineOpIter=a.opIterator(this._alines_get(this._curLine)),this._curLineOpIterLine=this._curLine;for(var n=0,i=!1;!i;){if(!this._curLineOpIter.hasNext()){r.error("Changeset.inverse error! cs("+this._cs+"),curALine("+this._alines_get(this._curLine)+")");break}this._curLineOpIter.next(this._curLineNextOp),n+this._curLineNextOp.chars>=this._curChar?(this._curLineNextOp.chars-=this._curChar-n,i=!0):n+=this._curLineNextOp.chars}}for(;t>0;){if(this._curLine>=this._alines_length()){r.error("Changeset.inverse error,index out of bounds！cs("+this._cs+"),curLine("+this._curLine+")");break}this._curLineNextOp.chars||this._curLineOpIter.hasNext()||(this._curLine++,this._curChar=0,this._curLineOpIterLine=this._curLine,this._curLineNextOp.chars=0,this._curLineOpIter=a.opIterator(this._alines_get(this._curLine))),this._curLineNextOp.chars||this._curLineOpIter.next(this._curLineNextOp);var s=Math.min(t,this._curLineNextOp.chars);e&&e(s,this._curLineNextOp.attribs,s===this._curLineNextOp.chars&&this._curLineNextOp.lines>0),t-=s,this._curLineNextOp.chars-=s,this._curChar+=s}this._curLineNextOp.chars||this._curLineOpIter.hasNext()||(this._curLine++,this._curChar=0)},t.prototype._skip=function(t,e){e>0?(this._curLine+=e,this._curChar=0):this._curLineOpIter&&this._curLineOpIterLine===this._curLine?this._consumeAttribRuns(t):this._curChar+=t},t.prototype._nextText=function(t){var e=0,r=a.stringAssembler(),n=this._lines_get(this._curLine).substring(this._curChar);e+=n.length,r.append(n);for(var i=this._curLine+1;e<t;){var s=this._lines_get(i);e+=s.length,r.append(s),i++}return r.toString().substring(0,t)},t.prototype._cachedStrFunc=function(t){var e=new Map;return function(r){return e.get(r)||e.set(r,t(r)),e.get(r)}},t.prototype.inverse=function(){var t=this;if(!this._csIter||!this._builder)return"";for(var e=[],r=[],n=function(){var n=i._csIter.next();if("="===n.opcode)if(n.attribs){e.length=0,r.length=0,a.eachAttribNumber(n.attribs,(function(n){e.push(t._pool.getAttribKey(n)),r.push(t._pool.getAttribValue(n))}));var s=i._cachedStrFunc((function(n){for(var i=[],s=0;s<e.length;s++){var o=e[s],p=r[s],c=a.attribsAttributeValue(n,o,t._pool);p!==c&&i.push([o,c])}return a.makeAttribsString("=",i,t._pool)}));i._consumeAttribRuns(n.chars,(function(e,r,n){t._builder&&t._builder.keep(e,n?1:0,s(r))}))}else i._skip(n.chars,n.lines),i._builder.keep(n.chars,n.lines);else if("+"===n.opcode)i._builder.remove(n.chars,n.lines);else if("-"===n.opcode){var o=i._nextText(n.chars),p=0;i._consumeAttribRuns(n.chars,(function(e,r,n){t._builder&&t._builder.insert(o.substr(p,e),r),p+=e}))}},i=this;this._csIter.hasNext();)n();return a.checkRep(this._builder.toString())},t}(),a=function(){function t(){}return t.parseNum=function(t){return parseInt(t,36)},t.numToString=function(t){return t.toString(36).toLowerCase()},t.toBaseTen=function(e){var r=e.indexOf("$"),n=e.substring(0,r),i=e.substring(r);return n.replace(/[0-9a-z]+/g,(function(e){return String(t.parseNum(e))}))+i},t.oldLen=function(e){var r=t.unpack(e);return r?r.oldLen:0},t.newLen=function(e){var r=t.unpack(e);return r?r.newLen:0},t.charBank=function(e){var r=t.unpack(e);return r?r.charBank:""},t.isEmpty=function(e){var r=t.unpack(e);if(r)for(var n=t.opIterator(r.opsStr);n.hasNext();){var i=n.next();if("="!==i.opcode||i.attribs)return!1}return!0},t.clearOp=function(t){t.opcode="",t.chars=0,t.lines=0,t.attribs=""},t.newOp=function(t){return{opcode:t||"",chars:0,lines:0,attribs:""}},t.cloneOp=function(t){return{opcode:t.opcode,chars:t.chars,lines:t.lines,attribs:t.attribs}},t.copyOp=function(t,e){e.opcode=t.opcode,e.chars=t.chars,e.lines=t.lines,e.attribs=t.attribs},t.opString=function(e){if(!e.opcode)return"null";var r=t.opAssembler();return r.append(e),r.toString()},t.stringOp=function(e){return t.opIterator(e).next()},t.opAssembler=function(){return new c},t.opIterator=function(t,e){return new n(t,e)},t.mergingOpAssembler=function(){return new u},t.stringAssembler=function(){return new h},t.smartOpAssembler=function(){return new l},t.stringIterator=function(t){return new i(t)},t.textLinesMutator=function(t){return new s(t)},t.checkRep=function(e){var n=t.unpack(e);if(n){for(var i=n.oldLen,s=n.newLen,o=n.opsStr,p=n.charBank,a=t.smartOpAssembler(),c=0,h=0,u=0,l=t.opIterator(o);l.hasNext();){var _=l.next();switch(_.opcode){case"=":c+=_.chars,h+=_.chars;break;case"-":c+=_.chars,r.assert(c<i,String(c)," >= ",String(i)," in ",e);break;case"+":h+=_.chars,u+=_.chars,r.assert(h<=s,String(h)," > ",String(s)," in ",e)}a.append(_)}for(h+=i-c,p=p.substring(0,u);p.length<u;)p+="?";a.endDocument();var f=t.pack({oldLen:i,newLen:h,opsStr:a.toString(),charBank:p});r.assert(f===e,f," !== ",e)}return e},t.prototype.checkRepWithText=function(e,n){var i=t.unpack(e);if(i){for(var s=i.oldLen,o=(i.newLen,i.opsStr),p=i.charBank,a=t.smartOpAssembler(),c=0,h=0,u=0,l=t.opIterator(o);l.hasNext();){var _=l.next();switch(_.opcode){case"=":c+=_.chars,h+=_.chars;break;case"-":c+=_.chars,r.assert(c<s,String(c)," >= ",String(s)," in ",e);break;case"+":h+=_.chars,u+=_.chars}a.append(_)}for(h+=s-c,p=p.substring(0,u);p.length<u;)p+="?";a.endDocument();var f=t.pack({oldLen:s,newLen:h,opsStr:a.toString(),charBank:p});r.assert(f===e,f," !== ",e)}return e},t.unpack=function(e){var n=/Z:([0-9a-z]+)([><])([0-9a-z]+)|/.exec(e);if(n&&n[0]){var i=t.parseNum(n[1]),s=i+(">"===n[2]?1:-1)*t.parseNum(n[3]),o=n[0].length,p=e.indexOf("$");return p<0&&(p=e.length),{oldLen:i,newLen:s,opsStr:e.substring(o,p),charBank:e.substring(p+1)}}return r.error("Not a changeset: "+e),null},t.pack=function(e){var r=e.newLen-e.oldLen,n=r>=0?">"+t.numToString(r):"<"+t.numToString(-r);return"Z:"+t.numToString(e.oldLen)+n+e.opsStr+"$"+e.charBank},t.applyZip=function(e,r,n,i,s){for(var o=t.opIterator(e,r),p=t.opIterator(n,i),a=t.smartOpAssembler(),c=t.newOp(),h=t.newOp(),u=t.newOp();c.opcode||o.hasNext()||h.opcode||p.hasNext();)!c.opcode&&o.hasNext()&&o.next(c),!h.opcode&&p.hasNext()&&p.next(h),s(c,h,u),u.opcode&&(a.append(u),u.opcode="");return a.endDocument(),a.toString()},t.applyToText=function(e,n){var i=t.unpack(e);if(i){r.assert(n.length===i.oldLen,"mismatched apply: ",String(n.length)," / ",String(i.oldLen));for(var s=t.opIterator(i.opsStr),o=t.stringIterator(i.charBank),p=t.stringIterator(n),a=t.stringAssembler();s.hasNext();){var c=s.next();switch(c.opcode){case"+":a.append(o.take(c.chars));break;case"-":p.skip(c.chars);break;case"=":a.append(p.take(c.chars))}}return a.append(p.take(p.remaining())),a.toString()}return""},t.getNewlyMentionedEncryptedUserIds=function(e,r){var n=[],i=t.unpack(e);if(i)for(var s=t.opIterator(i.opsStr);s.hasNext();){var o=s.next();switch(o.opcode){case"+":var p=t.attribsAttributeValue(o.attribs,"link",r);if(p){var a=new RegExp(".*/ep/profile/(.*)"),c=p.match(a);c&&n.push(c[1])}}}return n},t.convertToKeeps=function(e){var r=t.mergingOpAssembler(),n=t.unpack(e);if(n){for(var i=t.opIterator(n.opsStr);i.hasNext();){var s=i.next(),o=t.newOp();t.copyOp(s,o),o.opcode="=",r.append(o)}return r.endDocument(),t.pack({oldLen:n.newLen,newLen:n.newLen,opsStr:r.toString(),charBank:""})}return""},t.applyToTextAsDiff=function(e,n,i,s,o,p){var a=t.mergingOpAssembler(),c=t.stringAssembler(),h=t.unpack(e);if(h){r.assert(n.length===h.oldLen,"mismatched apply: ",String(n.length)," / ",String(h.oldLen));for(var u=t.opIterator(h.opsStr),l=t.stringIterator(h.charBank),_=t.stringIterator(n),f=!0,g=[];u.hasNext();){var d=u.next(),b=t.newOp();switch(t.copyOp(d,b),d.opcode){case"+":var m=l.take(d.chars);r.trim(m),i&&(b.attribs+="*"+t.numToString(i)),a.append(b),c.append(m),f=!1;break;case"-":var S=_.take(d.chars);""!==r.trim(S)&&(d.attribs||p)?(b.opcode="=",s&&(b.attribs+="*"+t.numToString(s)),a.append(b)):a.append(b),f=!1,d.lines,d.chars;break;case"=":var x=_.take(d.chars);if(d.attribs)t.eachAttribNumber(d.attribs,(function(t){g.push(t)})),i&&(b.attribs+="*"+t.numToString(i)),a.append(b);else{var v=x.split("\n");if(v.length>4||f&&v.length>3){var A=v[0],L=v[v.length-1];if(f)A="";else(y=t.newOp()).opcode="=",y.chars=A.length+1,y.lines=1,o&&(y.attribs+="*"+t.numToString(o)),a.append(y);(T=t.newOp()).opcode="-",f?(T.chars=x.length-(L.length+1),T.lines=v.length-2):(T.chars=x.length-(A.length+1)-(L.length+1),T.lines=v.length-3),a.append(T),(w=t.newOp()).opcode="=",w.chars=L.length+1,w.lines=1,o&&(w.attribs+="*"+t.numToString(o)),a.append(w)}else{if(f&&v.length>1)(T=t.newOp()).opcode="-",T.chars=v[0].length+1,T.lines=1,a.append(T),(w=t.newOp()).opcode="=",w.chars=d.chars-(v[0].length+1),w.lines=d.lines-1,o&&(w.attribs+="*"+t.numToString(o)),a.append(w);else a.append(b)}}f=!1}}var O=_.take(_.remaining()),k=O.split("\n");if(k.length>2){var y,T,w;A=k[0],L=k[k.length-1];if(f)A="";else(y=t.newOp()).opcode="=",y.chars=A.length+1,y.lines=1,o&&(y.attribs+="*"+t.numToString(o)),a.append(y);(T=t.newOp()).opcode="-",f?(T.chars=O.length-(L.length+1),T.lines=k.length-2):(T.chars=O.length-(A.length+1)-(L.length+1),T.lines=k.length-3),o&&(T.attribs+="*"+t.numToString(o)),a.append(T),(w=t.newOp()).opcode="=",w.chars=L.length+1,w.lines=1,o&&(w.attribs+="*"+t.numToString(o)),a.append(w)}}return""},t.mutateTextLines=function(e,r){var n=t.unpack(e);if(n){for(var i=t.opIterator(n.opsStr),s=t.stringIterator(n.charBank),o=t.textLinesMutator(r);i.hasNext();){var p=i.next();switch(p.opcode){case"+":o.insert(s.take(p.chars),p.lines);break;case"-":o.remove(p.chars,p.lines);break;case"=":o.skip(p.chars,p.lines,!!p.attribs)}}o.close()}},t.composeAttributes=function(e,r,n,i){if(!e&&n)return r;if(!r||!i)return e;var s=[];e.replace(/\*([0-9a-z]+)/g,(function(e,r){var n=i.getAttrib(t.parseNum(r));return n&&s.push(n),""})),r.replace(/\*([0-9a-z]+)/g,(function(e,r){var o=i.getAttrib(t.parseNum(r));if(o){for(var p=!1,a=0;a<s.length;a++){var c=s[a];if(c[0]===o[0]){o[1]||n?c[1]=o[1]:s.splice(a,1),p=!0;break}}p||!o[1]&&!n||s.push(o)}return""})),s.sort();for(var o=t.stringAssembler(),p=0;p<s.length;p++)o.append("*"),o.append(t.numToString(i.putAttrib(s[p])));return o.toString()},t._slicerZipperFunc=function(e,r,n,i){if("-"===e.opcode)t.copyOp(e,n),e.opcode="";else if(e.opcode.length<=0)t.copyOp(r,n),r.opcode="";else switch(r.opcode){case"-":r.chars<=e.chars?("="===e.opcode&&(n.opcode="-",n.chars=r.chars,n.attribs=""),e.chars-=r.chars,r.opcode="",e.chars||(e.opcode="")):("="===e.opcode&&(n.opcode="-",n.chars=e.chars,n.attribs=""),r.chars-=e.chars,e.opcode="");break;case"+":t.copyOp(r,n),r.opcode="";break;case"=":r.chars<=e.chars?(n.opcode=e.opcode,n.chars=r.chars,n.attribs=t.composeAttributes(e.attribs,r.attribs,"="===e.opcode,i),r.opcode="",e.chars-=r.chars,e.chars||(e.opcode="")):(n.opcode=e.opcode,n.chars=e.chars,n.attribs=t.composeAttributes(e.attribs,r.attribs,"="===e.opcode,i),e.opcode="",r.chars-=e.chars);break;case"":t.copyOp(e,n),e.opcode=""}},t.applyToAttribution=function(e,r,n){var i=t.unpack(e);return i?t.applyZip(r,0,i.opsStr,0,(function(e,r,i){return t._slicerZipperFunc(e,r,i,n)})):""},t.mutateAttributionLines=function(e,n,i){var s=null,o=null,p=t.textLinesMutator(n);function a(){return s&&s.hasNext()||p.hasMore()}function c(e){o||(o=t.mergingOpAssembler()),o.append(e),e.lines>0&&(r.assert(1===e.lines,"Can't have op.lines of ",String(e.lines)," in attribution lines"),p.insert(o.toString(),1),o=null)}var h=t.unpack(e);if(h){for(var u=t.opIterator(h.opsStr),l=h.charBank,_=0,f=t.newOp(),g=t.newOp(),d=t.newOp();(f.opcode||u.hasNext()||g.opcode||a())&&(!f.opcode&&u.hasNext()&&u.next(f),f.opcode||g.opcode||o||s&&s.hasNext());)if(!("="===f.opcode&&f.lines>0)||f.attribs||g.opcode||o||s&&s.hasNext())if("+"===f.opcode){if(f.lines>1){var b=l.indexOf("\n",_)+1-_;t.copyOp(f,d),f.chars-=b,f.lines--,d.lines=1,d.chars=b}else t.copyOp(f,d),f.opcode="";c(d),_+=d.chars,d.opcode=""}else{if(!g.opcode&&a()){if((!s||!s.hasNext())&&p.hasMore()){var m=p.removeLines(1);s=t.opIterator(m)}s&&s.hasNext()?s.next(g):g.opcode=""}t._slicerZipperFunc(g,f,d,i),d.opcode&&(c(d),d.opcode="")}else p.skipLines(f.lines),f.opcode="";r.assert(!o,"line assembler not finished"),p.close()}},t.joinAttributionLines=function(e){for(var r=t.mergingOpAssembler(),n=0;n<e.length;n++)for(var i=e[n],s=t.opIterator(i);s.hasNext();)r.append(s.next());return r.toString()},t.splitAttributionLines=function(e,n){var i=t.opIterator(e),s=t.mergingOpAssembler(),o=[],p=0;function a(t){s.append(t),t.lines>0&&(o.push(s.toString()),s.clear()),p+=t.chars}for(;i.hasNext();){for(var c=i.next(),h=c.chars,u=c.lines;u>1;){var l=n.indexOf("\n",p)+1;r.assert(l>0,"newlineEnd <= 0 in splitAttributionLines"),c.chars=l-p,c.lines=1,a(c),h-=c.chars,u-=c.lines}1===u&&(c.chars=h,c.lines=1),a(c)}return o},t.splitTextLines=function(t){return t.match(/[^\n]*(?:\n|[^\n]$)/g)},t.canCompose=function(e,r){var n=t.unpack(e),i=t.unpack(r);return!(!n||!i)&&n.newLen===i.oldLen},t.isInverseCsPair=function(e,r){var n=t.unpack(e),i=t.unpack(r);return!(!n||!i)&&(n.newLen===i.oldLen&&i.newLen===n.oldLen)},t.compose=function(e,n,i){var s=t.unpack(e),o=t.unpack(n);if(s&&o){var p=s.oldLen,a=s.newLen;r.assert(a===o.oldLen,"mismatched composition "+e+" "+n);var c=o.newLen,h=t.stringIterator(s.charBank),u=t.stringIterator(o.charBank),l=t.stringAssembler(),_=t.applyZip(s.opsStr,0,o.opsStr,0,(function(e,r,n){var s=e.opcode,o=r.opcode;"+"===s&&"-"===o&&h.skip(Math.min(e.chars,r.chars)),t._slicerZipperFunc(e,r,n,i),"+"===n.opcode&&("+"===o?l.append(u.take(n.chars)):l.append(h.take(n.chars)))}));return t.pack({oldLen:p,newLen:c,opsStr:_,charBank:l.toString()})}return""},t.attributeTester=function(e,r){function n(t){return!1}if(!r)return n;var i=r.putAttrib(e,!0);if(i<0)return n;var s=new RegExp("\\*"+t.numToString(i)+"(?!\\w)");return function(t){return s.test(t)}},t.identity=function(e){return t.pack({oldLen:e,newLen:e,opsStr:"",charBank:""})},t.makeSplice=function(e,r,n,i,s,o){var p=e.length;r>=p&&(r=p-1),n>e.length-r-1&&(n=e.length-r-1);var a=e.substring(r,r+n),c=p+i.length-a.length,h=t.smartOpAssembler();return h.appendOpWithText("=",e.substring(0,r)),h.appendOpWithText("-",a),h.appendOpWithText("+",i,s,o),h.endDocument(),t.pack({oldLen:p,newLen:c,opsStr:h.toString(),charBank:i})},t.toSplices=function(e){var r=[],n=t.unpack(e);if(n)for(var i=0,s=t.opIterator(n.opsStr),o=t.stringIterator(n.charBank),p=!1;s.hasNext();){var a=s.next();"="===a.opcode?(i+=a.chars,p=!1):(p||(r.push([i,i,""]),p=!0),"-"===a.opcode?(i+=a.chars,r[r.length-1][1]+=a.chars):"+"===a.opcode&&(r[r.length-1][2]+=o.take(a.chars)))}return r},t.characterRangeFollow=function(e,r,n,i){for(var s=r,o=n,p=t.toSplices(e),a=0,c=0;c<p.length;c++){var h=p[c],u=h[0]+a,l=h[1]+a,_=h[2].length,f=_-(l-u);u<=s&&l>=o?s=o=i?u:u+_:l<=s?(s+=f,o+=f):u>=o||(u>=s&&l<=o?o+=f:l<o?(s=u+_,o+=f):o=u),a+=f}return[s,o]},t.moveOpsToNewPool=function(e,r,n){var i=e.indexOf("$");i<0&&(i=e.length);var s=e.substring(0,i),o=e.substring(i);return s.replace(/\*([0-9a-z]+)/g,(function(e,i){var s=t.parseNum(i),o=r.getAttrib(s);if(!o)return"";var p=n.putAttrib(o);return"*"+t.numToString(p)}))+o},t.moveRangeOpsToNewPool=function(e,r,n){if(e.length&&r&&n){for(var i=[],s=0;s<e.length;s++){i.push([]);for(var o=0;o<e[0].length;o++)e[s][o]?i[s].push(t.moveOpsToNewPool(e[s][o],r,n)):i[s].push("")}return i}return null},t.makeAttribution=function(e){var r=t.smartOpAssembler();return r.appendOpWithText("+",e),r.toString()},t.eachAttribNumber=function(e,r){var n=e.indexOf("$");n<0&&(n=e.length),e.substring(0,n).replace(/\*([0-9a-z]+)/g,(function(e,n){return r(t.parseNum(n)),""}))},t.filterAttribNumbers=function(e,r){return t.mapAttribNumbers(e,r)},t.mapAttribNumbers=function(e,r){var n=e.indexOf("$");return n<0&&(n=e.length),e.substring(0,n).replace(/\*([0-9a-z]+)/g,(function(e,n){var i=r(t.parseNum(n));return!0===i?e:"number"==typeof i?"*"+t.numToString(i):""}))+e.substring(n)},t.makeAText=function(e,r){return{text:e,attribs:r||t.makeAttribution(e)}},t.applyToAText=function(e,r,n){return{text:t.applyToText(e,r.text),attribs:t.applyToAttribution(e,r.attribs,n)}},t.applyToATextAsDiff=function(e,r,n){return{text:t.applyToTextAsDiff(e,r.text),attribs:t.applyToAttribution(e,r.attribs,n)}},t.cloneAText=function(t){return{text:t.text,attribs:t.attribs}},t.copyAText=function(t,e){e.text=t.text,e.attribs=t.attribs},t.appendATextToAssembler=function(e,r,n){for(var i=t.opIterator(e.attribs),s=t.newOp();i.hasNext();)i.next(s),i.hasNext()||n?r.append(s):(s.chars--,s.chars&&r.append(s))},t.prepareForWire=function(r,n){var i=new e;return{translated:t.moveOpsToNewPool(r,n,i),pool:i}},t.isIdentity=function(e){var r=t.unpack(e);return!r||""===r.opsStr&&r.oldLen===r.newLen},t.opAttributeValue=function(e,r,n){return t.attribsAttributeValue(e.attribs,r,n)},t.attribsAttributeValue=function(e,r,n){var i="";return e&&t.eachAttribNumber(e,(function(t){n.getAttribKey(t)===r&&(i=n.getAttribValue(t))})),i},t.builder=function(t){return new o(t)},t.makeAttribsString=function(e,r,n){if(!r)return"";if("string"==typeof r)return r;if(n&&r&&r.length>0){(r=r).length>1&&(r=r.slice()).sort();for(var i=[],s=0;s<r.length;s++){var o=r[s];("="===e||"+"===e&&o[1])&&i.push("*"+t.numToString(n.putAttrib(o)))}return i.join("")}return""},t.subattribution=function(e,r,n){var i=t.opIterator(e,0),s=t.smartOpAssembler(),o=t.newOp(),p=t.newOp(),a=t.newOp();function c(){if(p.chars)for(;p.opcode&&(o.opcode||i.hasNext());)o.opcode||i.next(o),p.opcode&&o.opcode&&p.chars>=o.chars&&o.lines>0&&p.lines<=0&&p.lines++,t._slicerZipperFunc(o,p,a,null),a.opcode&&(s.append(a),a.opcode="")}if(p.opcode="-",p.chars=r,c(),void 0===n)for(o.opcode&&s.append(o);i.hasNext();)i.next(o),s.append(o);else p.opcode="=",p.chars=n-r,c();return s.toString()},t.inverse=function(t,e,r,n){return new p(t,e,r,n).inverse()},t.follow=function(e,n,i,s,o){var p=t.unpack(e),a=t.unpack(n);if(p&&a){var c=p.oldLen,h=a.oldLen;r.assert(c===h,"mismatched follow:"+e+" "+n);var u=t.stringIterator(p.charBank),l=t.stringIterator(a.charBank),_=p.newLen,f=0,g=0,d=t.attributeTester(["insertorder","first"],s),b=t.attributeTester(["del-first","true"],s),m=t.stringAssembler(),S=t.applyZip(p.opsStr,0,a.opsStr,0,(function(e,r,n){if("+"===e.opcode&&"-"===r.opcode&&b(e.attribs))e.opcode="",n.opcode="-",n.chars=e.chars,n.attribs="";else if("-"===e.opcode&&"+"===r.opcode&&b(r.attribs))r.opcode="",l.skip(r.chars);else if("+"===e.opcode||"+"===r.opcode){var o=void 0;if("+"!==r.opcode)o=1;else if("+"!==e.opcode)o=2;else{var p=u.peek(1),a=l.peek(1),c=d(e.attribs),h=d(r.attribs);o=c&&!h?1:h&&!c||"\n"===p&&"\n"!==a?2:"\n"!==p&&"\n"===a?1:i?2:1}1===o?(u.skip(e.chars),n.opcode="=",n.chars=e.chars,n.attribs="",e.opcode=""):(m.append(l.take(r.chars)),t.copyOp(r,n),r.opcode="")}else"-"===e.opcode?r.opcode?e.chars<=r.chars?(r.chars-=e.chars,e.opcode="",r.chars||(r.opcode="")):(e.chars-=r.chars,r.opcode=""):e.opcode="":"-"===r.opcode?(t.copyOp(r,n),e.opcode?r.chars<=e.chars?(e.chars-=r.chars,r.opcode="",e.chars||(e.opcode="")):(n.chars=e.chars,r.chars-=e.chars,e.opcode=""):r.opcode=""):e.opcode?r.opcode?(n.opcode="=",n.attribs=t.followAttributes(e.attribs,r.attribs,s),e.chars<=r.chars?(n.chars=e.chars,r.chars-=e.chars,e.opcode="",r.chars||(r.opcode="")):(n.chars=r.chars,e.chars-=r.chars,r.opcode="")):e.opcode="":(t.copyOp(r,n),r.opcode="");switch(n.opcode){case"=":f+=n.chars,g+=n.chars;break;case"-":f+=n.chars;break;case"+":g+=n.chars}}));return g+=_-f,t.pack({oldLen:_,newLen:g,opsStr:S,charBank:m.toString()})}return""},t.followAttributes=function(e,r,n){if(!r||!n)return"";if(!e)return r;var i=[];r.replace(/\*([0-9a-z]+)/g,(function(e,r){var s=n.getAttrib(t.parseNum(r));return s&&i.push(s),""})),e.replace(/\*([0-9a-z]+)/g,(function(e,r){var s=n.getAttrib(t.parseNum(r));if(s)for(var o=0;o<i.length;o++){var p=i[o];if(s[0]===p[0]){s[1]<=p[1]&&i.splice(o,1);break}}return""}));for(var s=t.stringAssembler(),o=0;o<i.length;o++)s.append("*"),s.append(t.numToString(n.putAttrib(i[o])));return s.toString()},t.fixAText=function(e){var r=(e=e||{text:"",attribs:""}).text;e.attribs;r=r||"";var n=t.smartOpAssembler();return t.appendATextToAssembler(e,n,!0),"\n"!==r.substring(r.length-1)&&(n.appendOpWithText("+","\n"),r+="\n"),{text:r,attribs:r.length!==n.getLengthChange()?t.makeAttribution(r):n.toString()}},t.shouldFixAText=function(t){return!(t&&t.text&&(t.text.endsWith("\n")||t.text.endsWith(String.fromCharCode(7)))&&t.attribs)},t}(),c=function(){function t(){this._pieces=[]}return t.prototype.append=function(t){this._pieces.push(t.attribs),this._pieces.push(t.opcode),this._pieces.push(a.numToString(t.chars))},t.prototype.toString=function(){return this._pieces.join("")},t.prototype.clear=function(){this._pieces=[]},t}(),h=function(){function t(){this._pieces=[]}return t.prototype.append=function(t){this._pieces.push(t)},t.prototype.toString=function(){return this._pieces.join("")},t.prototype.clear=function(){this._pieces=[]},t}(),u=function(){function t(){this._assem=a.opAssembler(),this._bufOp=a.newOp(),this._bufOpAdditionalCharsAfterNewline=0}return t.prototype._flush=function(t){this._bufOp.opcode.length>0&&(t&&"="===this._bufOp.opcode&&!this._bufOp.attribs||(this._assem.append(this._bufOp),this._bufOpAdditionalCharsAfterNewline>0&&(this._bufOp.chars=this._bufOpAdditionalCharsAfterNewline,this._bufOp.lines=0,this._assem.append(this._bufOp),this._bufOpAdditionalCharsAfterNewline=0)),this._bufOp.opcode="")},t.prototype.append=function(t){t.chars>0&&(this._bufOp.opcode===t.opcode&&this._bufOp.attribs===t.attribs?t.lines>0?(this._bufOp.chars+=this._bufOpAdditionalCharsAfterNewline+t.chars,this._bufOp.lines+=t.lines,this._bufOpAdditionalCharsAfterNewline=0):0===this._bufOp.lines?this._bufOp.chars+=t.chars:this._bufOpAdditionalCharsAfterNewline+=t.chars:(this._flush(),a.copyOp(t,this._bufOp)))},t.prototype.endDocument=function(){this._flush(!0)},t.prototype.toString=function(){return this._flush(),this._assem.toString()},t.prototype.clear=function(){this._assem.clear(),a.clearOp(this._bufOp)},t}(),l=function(){function t(){this._minusAssem=a.mergingOpAssembler(),this._plusAssem=a.mergingOpAssembler(),this._keepAssem=a.mergingOpAssembler(),this._assem=a.stringAssembler(),this._lastOpcode="",this._lengthChange=0}return t.prototype._flushKeeps=function(){this._assem.append(this._keepAssem.toString()),this._keepAssem.clear()},t.prototype._flushPlusMinus=function(){this._assem.append(this._minusAssem.toString()),this._minusAssem.clear(),this._assem.append(this._plusAssem.toString()),this._plusAssem.clear()},t.prototype.append=function(t){"-"===t.opcode?("="===this._lastOpcode&&this._flushKeeps(),this._minusAssem.append(t),this._lengthChange-=t.chars):"+"===t.opcode?("="===this._lastOpcode&&this._flushKeeps(),this._plusAssem.append(t),this._lengthChange+=t.chars):"="===t.opcode&&("="!==this._lastOpcode&&this._flushPlusMinus(),this._keepAssem.append(t)),this._lastOpcode=t.opcode},t.prototype.appendOpWithText=function(t,e,r,n){var i=a.newOp(t);i.attribs=a.makeAttribsString(t,r,n),i.chars=e.length,i.lines=0,this.append(i)},t.prototype.toString=function(){return this._flushPlusMinus(),this._flushKeeps(),this._assem.toString()},t.prototype.clear=function(){this._minusAssem.clear(),this._plusAssem.clear(),this._keepAssem.clear(),this._assem.clear(),this._lengthChange=0},t.prototype.endDocument=function(){this._keepAssem.endDocument()},t.prototype.getLengthChange=function(){return this._lengthChange},t}();return t.AttribPool=e,t.CSMergingOpAssembler=u,t.CSSmartOpAssembler=l,t.CSStringAssembler=h,t.CSStringIter=i,t.CSTextLinesMutator=s,t.Changeset=a,t.ChangesetBuilder=o,t.ChangesetInverse=p,t.ChangesetOpAssembler=c,t.ChangesetOpIter=n,t.ChangesetTool=r,t}({});
//# sourceMappingURL=easysync.iife.js.map
